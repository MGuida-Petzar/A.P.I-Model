<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>A.P.I - Studio</title>
<style>
  html, body { height: 100%; margin: 0; padding: 0; background: #0b0b0b; overflow: hidden; width: 100%; }
  canvas { display: block; width: 100vw; height: 100vh; position: fixed; top: 0; left: 0; }

  #loading-overlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(11, 11, 11, 0.85);
    backdrop-filter: blur(12px);
    display: flex; flex-direction: column;
    justify-content: center; align-items: center;
    z-index: 1000;
    transition: opacity 0.4s ease;
    pointer-events: none;
    opacity: 0;
  }

  .loader-text { color: #d0bcff; font-family: 'Segoe UI', sans-serif; font-size: 1.4rem; font-weight: 600; margin-bottom: 20px; }
  .progress-container { width: 280px; height: 4px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; overflow: hidden; }
  #progress-bar { width: 0%; height: 100%; background: #d0bcff; box-shadow: 0 0 15px rgba(208, 188, 255, 0.4); transition: width 0.2s ease; }

  .lil-gui { 
    --background-color: rgba(28, 27, 31, 0.92);
    --text-color: #e6e1e5;
    --widget-color: #4f378b; 
    --hover-color: #6750a4;
    --focus-color: #d0bcff;
    border-radius: 32px !important; 
    padding: 20px !important;
    backdrop-filter: blur(14px);
    font-family: 'Segoe UI', sans-serif !important;
  }
</style>

  <script type="importmap">
  {
    "imports": { "three": "https://cdn.jsdelivr.net/npm/three@0.144.0/build/three.module.js" }
  }
  </script>
</head>
<body>
  <div id="loading-overlay">
    <div class="loader-text">Loading A.P.I Environment... <span id="percent">0%</span></div>
    <div class="progress-container"><div id="progress-bar"></div></div>
  </div>

  <canvas id="canvas"></canvas>

  <script type="module">
    import * as THREE from 'three';
    import { GLTFLoader } from 'https://cdn.jsdelivr.net/npm/three@0.144.0/examples/jsm/loaders/GLTFLoader.js';
    import { OrbitControls } from 'https://cdn.jsdelivr.net/npm/three@0.144.0/examples/jsm/controls/OrbitControls.js';
    import { RGBELoader } from 'https://cdn.jsdelivr.net/npm/three@0.144.0/examples/jsm/loaders/RGBELoader.js'; // Added for reflections
    import GUI from 'https://cdn.jsdelivr.net/npm/lil-gui@0.18.0/dist/lil-gui.esm.min.js';

    // --- 1. CONFIG ---
    const modelUrlA = 'https://mguida-petzar.github.io/A.P.I-Model/new-folder/Project%20API21.glb';
    const modelUrlB = 'https://mguida-petzar.github.io/A.P.I-Model/new-folder/Project%20API22OFF.glb'; 
    const modelUrlC = 'https://mguida-petzar.github.io/A.P.I-Model/new-folder/Project%20API23Metal.glb'; 
    const modelUrlD = 'https://mguida-petzar.github.io/A.P.I-Model/new-folder/Project%20API23Gravony.glb'; 
    const hdrUrl = 'https://dl.polyhaven.org/file/ph-assets/HDRIs/hdr/1k/studio_small_08_1k.hdr'; // Studio Environment

    const overlay = document.getElementById('loading-overlay');
    const progressBar = document.getElementById('progress-bar');
    const percentText = document.getElementById('percent');

    const canvas = document.getElementById('canvas');
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.outputEncoding = THREE.sRGBEncoding;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 0.8; 
    renderer.physicallyCorrectLights = true;

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0b0b0b);

    const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    // --- 2. LIGHTING & ENVIRONMENT ---
    const ambientFill = new THREE.AmbientLight(0xffffff, 1.0);
    scene.add(ambientFill);

    const sunLight = new THREE.DirectionalLight(0xffffff, 2.5);
    scene.add(sunLight);

    // Load Environment Map
    const rgbeLoader = new RGBELoader();
    let envMap = null;

    rgbeLoader.load(hdrUrl, (texture) => {
        texture.mapping = THREE.EquirectangularReflectionMapping;
        envMap = texture;
        // Apply it by default
        scene.environment = envMap;
    });

    // --- 3. STATE ---
    let currentModel = null;
    let modelMaterials = [];
    const loader = new GLTFLoader();

    const params = {
      modelVariant: 'Full Body',
      showEnvironment: true, // New Toggle
      metalness: 1.0, 
      roughness: 0.1, // Lower roughness = better reflections
      enableSun: true,
      lightAzimuth: 0,
      lightElevation: 40.5,
      reset: function() {
          params.modelVariant = 'Full Body';
          params.showEnvironment = true;
          params.metalness = 1.0;
          params.roughness = 0.1;
          updateEnvironment();
          updateLightLogic();
          updateModelSelection();
          gui.controllersRecursive().forEach(c => c.updateDisplay());
      }
    };

    function updateEnvironment() {
        scene.environment = params.showEnvironment ? envMap : null;
    }

    function updateLightLogic() {
        sunLight.visible = params.enableSun;
        const phi = THREE.MathUtils.degToRad(90 - params.lightElevation);
        const theta = THREE.MathUtils.degToRad(params.lightAzimuth);
        sunLight.position.setFromSphericalCoords(10, phi, theta);
    }

    function updateModelSelection() {
        let selectedUrl;
        switch(params.modelVariant) {
            case 'Full Body': selectedUrl = modelUrlA; break;
            case 'Leg Off':   selectedUrl = modelUrlB; break;
            case 'Reflection': selectedUrl = modelUrlC; break;
            case 'Gravony':    selectedUrl = modelUrlD; break;
            default:           selectedUrl = modelUrlA;
        }
        loadModel(selectedUrl);
    }

    function loadModel(url) {
        overlay.style.opacity = "1";
        if (currentModel) { scene.remove(currentModel); modelMaterials = []; }

        loader.load(url, (gltf) => {
            currentModel = gltf.scene;
            currentModel.traverse(n => {
                if (n.isMesh && n.material) {
                    n.material.metalness = params.metalness;
                    n.material.roughness = params.roughness;
                    n.material.envMapIntensity = 1.5; // Boost the reflection brightness
                    modelMaterials.push(n.material);
                }
            });
            scene.add(currentModel);

            const box = new THREE.Box3().setFromObject(currentModel);
            const center = box.getCenter(new THREE.Vector3());
            const size = box.getSize(new THREE.Vector3());
            currentModel.position.sub(center);
            const maxDim = Math.max(size.x, size.y, size.z);
            const cameraZ = Math.abs(maxDim / 2 / Math.tan((camera.fov * Math.PI / 180) / 2));
            camera.position.set(0, maxDim * 0.2, cameraZ * 2.2);
            controls.target.set(0,0,0);
            controls.update();
            
            setTimeout(() => { overlay.style.opacity = "0"; }, 350);
        }, (xhr) => {
            if (xhr.lengthComputable) {
                const percent = (xhr.loaded / xhr.total) * 100;
                progressBar.style.width = percent + '%';
                percentText.innerText = Math.round(percent) + '%';
            }
        });
    }

    function updateMaterials() {
        modelMaterials.forEach(m => { 
            m.metalness = params.metalness; 
            m.roughness = params.roughness; 
        });
    }

    // --- 4. GUI ---
    const gui = new GUI({ title: 'A.P.I STUDIO' });
    const configFolder = gui.addFolder('ðŸ”§ A.P.I CONFIGURATION');
    configFolder.add(params, 'modelVariant', ['Full Body', 'Leg Off', 'Reflection', 'Gravony']).name('Model Variant').onChange(updateModelSelection);
    configFolder.add(params, 'showEnvironment').name('Enable Reflections').onChange(updateEnvironment);
    configFolder.open();

    const lightFolder = gui.addFolder('Dynamic Lighting');
    lightFolder.add(params, 'enableSun').name('Directional Light').onChange(updateLightLogic);
    lightFolder.add(params, 'lightAzimuth', 0, 360).name('H-Move').onChange(updateLightLogic);
    lightFolder.add(params, 'lightElevation', -90, 90).name('V-Move').onChange(updateLightLogic);

    const matFolder = gui.addFolder('Material Finish');
    matFolder.add(params, 'metalness', 0, 1).name('Metalness').onChange(updateMaterials);
    matFolder.add(params, 'roughness', 0, 1).name('Roughness').onChange(updateMaterials);
    gui.add(params, 'reset').name('Reset Studio');

    updateModelSelection();
    updateLightLogic();

    function animate() { requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
    animate();

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
